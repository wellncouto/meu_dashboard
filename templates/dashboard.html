{% extends 'base.html' %}

{% block title %}Tablero - Mi App Fin{% endblock %}

{# Sugest√£o: Fundo ligeiramente mais claro para desktop para um toque mais suave #}
{% block body_class %}bg-gray-50 lg:bg-gray-100{% endblock %}

{% block head_style %}
    {{ super() }}
    <style>
        /* Estilo para anima√ß√£o de feedback visual (exemplo) */
        @keyframes pulse-bg-success {
            0%, 100% { background-color: inherit; }
            50% { background-color: #dcfce7; } /* green-100 */
        }
        .animate-pulse-bg-success {
            animation: pulse-bg-success 1.5s ease-in-out;
        }
        #desktop-fab-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 20;
        }
    </style>
{% endblock %}


{% block content_body %}

    <div class="mb-6">
        <h2 class="text-3xl font-semibold text-[#065428]"><span id="dynamic-greeting">Hola</span>, {{ user_nome }}! üëã</h2>
        {# Sugest√£o: Pequeno aumento na margem para dar mais respiro #}
        <p class="text-gray-600 mt-2">Resumen de tus finanzas.</p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages-container" class="mb-6 space-y-3">
            {% for category, message in messages %}
                <div class="p-4 rounded-lg text-sm border flash-message-{{ category }}
                    {% if category == 'danger' %} bg-red-100 text-red-700 border-red-300
                    {% elif category == 'success' %} bg-green-100 text-green-700 border-green-300
                    {% elif category == 'warning' %} bg-yellow-100 text-yellow-700 border-yellow-300
                    {% else %} bg-blue-100 text-blue-700 border-blue-300 {% endif %}"
                    role="alert">
                    <span class="font-semibold">
                        {% if category == 'danger' %}Peligro
                        {% elif category == 'success' %}√âxito
                        {% elif category == 'warning' %}Advertencia
                        {% else %}{{ category|capitalize }}{% endif %}:
                    </span> {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

<div id="resumo-periodo-card" class="mb-8 p-6 sm:p-7 rounded-xl shadow-xl border-0 bg-gradient-to-br from-white to-gray-50 transition-all duration-300 hover:shadow-2xl">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-100">
        <div class="flex items-center">
            <span class="text-[#55d83f] mr-3 hidden sm:flex">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
            </span>
            <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2 sm:mb-0">
                Resumen: 
                <span class="bg-gradient-to-r from-[#065428] to-[#55d83f] bg-clip-text text-transparent">
                    {% if periodo_ativo == '7d' %}√öltimos 7 D√≠as
                    {% elif periodo_ativo == '15d' %}√öltimos 15 D√≠as
                    {% elif periodo_ativo == 'mes_atual' %}Mes Actual
                    {% else %}Mes Actual{% endif %}
                </span>
            </h3>
        </div>
        <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg shadow-inner mt-4 sm:mt-0">
            <a href="{{ url_for('dashboard', periodo='7d') }}" 
               class="px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 transform
                      {% if periodo_ativo == '7d' %}bg-white text-[#065428] shadow-md translate-y-0{% else %}text-gray-600 hover:bg-gray-200 hover:text-gray-800 hover:-translate-y-0.5{% endif %}">
                7 D√≠as
            </a>
            <a href="{{ url_for('dashboard', periodo='15d') }}" 
               class="px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 transform
                      {% if periodo_ativo == '15d' %}bg-white text-[#065428] shadow-md translate-y-0{% else %}text-gray-600 hover:bg-gray-200 hover:text-gray-800 hover:-translate-y-0.5{% endif %}">
                15 D√≠as
            </a>
            <a href="{{ url_for('dashboard', periodo='mes_atual') }}" 
               class="px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 transform
                      {% if periodo_ativo == 'mes_atual' %}bg-white text-[#065428] shadow-md translate-y-0{% else %}text-gray-600 hover:bg-gray-200 hover:text-gray-800 hover:-translate-y-0.5{% endif %}">
                Mes Actual
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-5">
        {# Sugest√£o: Bordas sutilmente mais vis√≠veis para melhor defini√ß√£o do card #}
        <div class="bg-white rounded-xl p-5 shadow-md border border-green-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex justify-between items-center">
                <p class="text-sm text-green-600 uppercase tracking-wider font-bold">Ingresos</p>
                <span class="bg-green-100 p-2 rounded-full text-green-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </span>
            </div>
            <p class="text-3xl sm:text-4xl font-extrabold text-green-600 mt-3 tracking-tight">
                {{ dados.total_receitas_mes | currency }}
            </p>
        </div>
        
        {# Sugest√£o: Bordas sutilmente mais vis√≠veis #}
        <div class="bg-white rounded-xl p-5 shadow-md border border-red-200 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex justify-between items-center">
                <p class="text-sm text-red-600 uppercase tracking-wider font-bold">Egresos</p>
                <span class="bg-red-100 p-2 rounded-full text-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                </span>
            </div>
            <p class="text-3xl sm:text-4xl font-extrabold text-red-600 mt-3 tracking-tight">
                {{ dados.total_despesas_mes | currency }}
            </p>
        </div>
        
        {# Sugest√£o: Bordas sutilmente mais vis√≠veis e consistentes #}
        <div class="bg-white rounded-xl p-5 shadow-md border {% if dados.saldo_mes > 0 %}border-green-200{% elif dados.saldo_mes < 0 %}border-red-200{% else %}border-gray-200{% endif %} hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
            <div class="flex justify-between items-center">
                <p class="text-sm text-gray-700 uppercase tracking-wider font-bold">Resultado</p>
                <span class="{% if dados.saldo_mes > 0 %}bg-green-100 text-green-500{% elif dados.saldo_mes < 0 %}bg-red-100 text-red-500{% else %}bg-gray-100 text-gray-500{% endif %} p-2 rounded-full">
                    {% if dados.saldo_mes > 0 %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    {% elif dados.saldo_mes < 0 %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                    {% endif %}
                </span>
            </div>
            <p class="text-3xl sm:text-4xl font-extrabold mt-3 tracking-tight
                {% if dados.saldo_mes > 0 %}text-green-600
                {% elif dados.saldo_mes < 0 %}text-red-600
                {% else %}text-gray-700{% endif %}">
                {{ dados.saldo_mes | currency }}
            </p>
        </div>
    </div>
</div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md border border-gray-200">
           <h3 class="text-lg font-semibold text-[#065428] mb-4">Gastos por Categor√≠a</h3>
           <div class="h-72">
               <canvas id="graficoGastosCategoria"></canvas>
           </div>
       </div>
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md border border-gray-200">
            <h3 class="text-lg font-semibold text-[#065428] mb-4">Movimientos Recientes</h3>
            {% if dados.movimentacoes_recentes %}
                <div class="space-y-3 max-h-[360px] overflow-y-auto pr-2">
                    {% for mov in dados.movimentacoes_recentes %}
                    <div class="flex justify-between items-center p-3 rounded-lg border
                        {% if mov.tipo_movimentacao == 'receita' %} bg-green-50 border-green-200 hover:bg-green-100
                        {% elif mov.tipo_movimentacao == 'gasto_variavel' or mov.tipo_movimentacao == 'gasto_fixo' or mov.tipo_movimentacao == 'gasto' %} bg-red-50 border-red-200 hover:bg-red-100
                        {% else %} bg-gray-50 border-gray-200 hover:bg-gray-100 {% endif %}
                        transition-colors duration-200">
                        <div class="flex items-center overflow-hidden">
                            <span class="flex-shrink-0 h-8 w-8 rounded-full mr-3 flex items-center justify-center text-xl
                                {% if mov.tipo_movimentacao == 'receita' %} bg-green-100 text-green-600">üí∞
                                {% elif mov.tipo_movimentacao == 'gasto_variavel' or mov.tipo_movimentacao == 'gasto_fixo' or mov.tipo_movimentacao == 'gasto' %} bg-red-100 text-red-600">üí∏
                                {% else %} bg-gray-100 text-gray-600">üìÑ
                                {% endif %}
                            </span>
                            <div class="flex-grow overflow-hidden">
                                <p class="font-semibold truncate {% if mov.tipo_movimentacao == 'receita' %}text-green-700{% elif mov.tipo_movimentacao == 'gasto_variavel' or mov.tipo_movimentacao == 'gasto_fixo' or mov.tipo_movimentacao == 'gasto' %}text-red-700{% else %}text-gray-800{% endif %}" title="{{ mov.categoria | default('Sin Categor√≠a', true) }}">{{ mov.categoria | default('Movimiento', true) }}</p>
                                <p class="text-xs text-gray-500">{{ mov.data | date }} {% if mov.descricao %}<span class="mx-1">&bull;</span> <span class="truncate" title="{{ mov.descricao }}">{{ mov.descricao }}</span>{% endif %}</p>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                            <p class="font-semibold text-sm {% if mov.tipo_movimentacao == 'receita' %}text-green-600{% elif mov.tipo_movimentacao == 'gasto_variavel' or mov.tipo_movimentacao == 'gasto_fixo' or mov.tipo_movimentacao == 'gasto' %}text-red-600{% else %}text-gray-700{% endif %}">{% if mov.tipo_movimentacao == 'receita' %}+{% elif mov.tipo_movimentacao == 'gasto_variavel' or mov.tipo_movimentacao == 'gasto_fixo' or mov.tipo_movimentacao == 'gasto' %}-{% endif %}{{ mov.valor | currency }}</p> {# Revisar filtro |currency para MXN no backend/config #}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-10 flex flex-col items-center justify-center h-full"><span class="text-4xl mb-2">ü§∑</span><h3 class="mt-2 text-sm font-medium text-gray-700">Ning√∫n movimiento reciente</h3><p class="mt-1 text-sm text-gray-500">Tus √∫ltimas transacciones aparecer√°n aqu√≠.</p></div>
            {% endif %}
        </div>
    </div>

<div class="grid grid-cols-1 md:grid-cols-1 gap-6 mb-8">
        <div class="md:col-span-1 bg-white p-4 sm:p-6 rounded-xl shadow-md border border-gray-200">
            <h3 class="text-lg font-semibold text-[#065428] mb-4">
                üìà Gastos Diarios: 
                <span class="font-bold">
                    {% if periodo_ativo == '7d' %}√öltimos 7 D√≠as
                    {% elif periodo_ativo == '15d' %}√öltimos 15 D√≠as
                    {% elif periodo_ativo == 'mes_atual' %}Mes Actual (hasta hoy)
                    {% else %}Mes Actual (hasta hoy){% endif %}
                </span>
            </h3>
            <div style="overflow-x: auto; /* Habilita a rolagem horizontal */ -webkit-overflow-scrolling: touch; /* Melhora scroll em iOS */">
                <div style="min-width: {{ dados.gastos_tempo_labels | length * 50 if (dados.gastos_tempo_labels | length * 30) > 400 else 400 }}px; /* Largura din√¢mica ou m√≠nima */ height: 288px; /* h-72 como antes */ position: relative;">
                    <canvas id="graficoGastosTempo"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-8 bg-white p-6 rounded-xl shadow-md border border-gray-200">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-[#065428]">üéØ Mi Meta Financiera</h3>
            {% if meta_ativa and meta_ativa.status == 'ativa' %}
            <button type="button" onclick="abrirModalMeta(true)" class="text-sm text-[#065428] hover:text-[#55d83f] font-medium flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
                Editar Meta
            </button>
            {% endif %}
        </div>

        {% if meta_ativa and meta_ativa.status == 'ativa' %}
            <div id="visualizacao-meta-ativa">
                <h4 class="text-lg font-medium text-[#55d83f]">{{ meta_ativa.descricao }}</h4>
                {# Sugest√£o: leading-relaxed para melhor leitura dos detalhes #}
                <div class="mt-2 space-y-1 text-sm text-gray-600 leading-relaxed">
                    <p><strong>Categor√≠a:</strong> {{ meta_ativa.categoria }}</p>
                    <p><strong>Valor Objetivo:</strong> <span class="font-semibold">{{ meta_ativa.valor_alvo | currency }}</span></p> {# Revisar filtro |currency para MXN no backend/config #}
                    {% if meta_ativa.prazo_meses %}
                        <p><strong>Plazo:</strong> {{ meta_ativa.prazo_meses }} mes{% if meta_ativa.prazo_meses > 1 %}es{% endif %}</p>
                        {% if meta_ativa.valor_mensal_sugerido %}
                        <p><strong>Sugerencia Mensual:</strong> {{ meta_ativa.valor_mensal_sugerido | currency }}</p> {# Revisar filtro |currency para MXN no backend/config #}
                        {% endif %}
                        {% if meta_ativa.data_conclusao_prevista %}
                            <p><strong>Previsi√≥n de Finalizaci√≥n:</strong> {{ meta_ativa.data_conclusao_prevista | date }}</p>
                        {% endif %}
                    {% else %}
                        <p><strong>Plazo:</strong> Indefinido</p>
                    {% endif %}
                    <p><strong>Valor Acumulado:</strong> <span class="font-semibold">{{ meta_ativa.valor_atual | currency }}</span></p> {# Revisar filtro |currency para MXN no backend/config #}
                </div>
                {% set progresso = 0 %}
                {% if meta_ativa.valor_alvo and meta_ativa.valor_alvo > 0 %}
                    {% set progresso = (meta_ativa.valor_atual / meta_ativa.valor_alvo) * 100 %}
                {% endif %}
                <div class="w-full bg-gray-200 rounded-full h-3.5 my-3 overflow-hidden">
                    <div class="bg-gradient-to-r from-[#b7ed51] to-[#55d83f] h-3.5 rounded-full transition-all duration-500 ease-out" style="width: {{ progresso }}%"></div>
                </div>
                <p class="text-sm text-gray-600 text-right">{{ "%.2f" | format(progresso) }}% alcanzado</p>
                <div class="mt-5 space-y-3">
                    <form action="{{ url_for('add_progresso_meta') }}" method="POST" class="flex items-center gap-2">
                        <input type="number" name="valor_progresso" step="0.01" min="0.01" placeholder="A√±adir $" required class="flex-grow px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10"> {# Placeholder de moeda revisado #}
                        <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-[#55d83f] rounded-lg hover:bg-[#47b333] focus:outline-none focus:ring-2 focus:ring-[#55d83f] focus:ring-offset-2 h-10 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                            Contribuir
                        </button>
                    </form>
                    <form id="cancel-meta-form" action="{{ url_for('cancelar_meta') }}" method="POST" class="w-full">
                        <button type="button" onclick="openConfirmCancelModal()" class="w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 h-10 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            Cancelar Meta
                        </button>
                    </form>
                </div>
            </div>
        {% elif meta_ativa and meta_ativa.status == 'concluida' %}
            <div id="visualizacao-meta-concluida" class="text-center py-6">
                <span class="text-5xl">üéâ</span>
                <h4 class="text-lg font-medium text-green-700 mt-2">¬°Felicidades! ¬°Meta Cumplida!</h4>
                <p class="text-gray-600 mt-1 leading-relaxed">Alcanzaste tu meta: <span class="font-semibold">{{ meta_ativa.descricao }}</span> ({{ meta_ativa.valor_alvo | currency }}).</p> {# Revisar filtro |currency para MXN no backend/config #}
                <button type="button" onclick="abrirModalMeta(false)" class="mt-4 px-4 py-2 text-sm font-medium text-white bg-[#55d83f] rounded-lg hover:bg-[#47b333] focus:outline-none focus:ring-2 focus:ring-[#55d83f] focus:ring-offset-2">
                    Crear Nueva Meta
                </button>
            </div>
        {% else %}
            <div id="sem-meta-ativa" class="text-center py-6">
                <span class="text-4xl">üèÅ</span>
                <h4 class="text-lg font-medium text-gray-700 mt-2">Ninguna meta definida.</h4>
                <p class="text-gray-500 mt-1 mb-4 leading-relaxed">¬øQu√© tal empezar a planificar tus objetivos?</p>
                <button type="button" onclick="abrirModalMeta(false)" class="px-6 py-2.5 text-sm font-medium text-white bg-[#55d83f] rounded-lg hover:bg-[#47b333] focus:outline-none focus:ring-2 focus:ring-[#55d83f] focus:ring-offset-2">
                    Definir Meta Financiera
                </button>
            </div>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-1 gap-6 mb-20"> {# Aumentei o mb para dar espa√ßo para o FAB no desktop #}
        <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-md border border-gray-200">
            <h3 class="text-lg font-semibold text-[#065428] mb-4">‚è∞ Pr√≥ximos Recordatorios</h3>
            {% if dados.proximos_lembretes %}
                <ul class="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                    {% for lembrete in dados.proximos_lembretes %}
                    <li class="p-3 bg-amber-50 border border-amber-200 rounded-md text-sm hover:bg-amber-100 transition-colors duration-150">
                        <div class="flex justify-between items-center"><span class="font-medium text-amber-800 truncate" title="{{ lembrete.descripcion }}">{{ lembrete.descripcion }}</span><span class="text-xs text-amber-600 whitespace-nowrap">{{ lembrete.data | date }}</span></div>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-center text-gray-500 py-4">üò¥ Ning√∫n recordatorio pr√≥ximo.</p>
            {% endif %}
        </div>
    </div>

    <div id="desktop-fab-container" class="hidden lg:block">
        <button id="open-add-modal-fab"
                class="bg-[#55d83f] hover:bg-[#47b333] text-white font-medium rounded-lg px-5 py-3 shadow-lg focus:outline-none focus:ring-2 focus:ring-[#55d83f] focus:ring-opacity-75 transition-all duration-150 ease-in-out hover:shadow-xl flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            A√±adir
        </button>
    </div>


    <div id="add-item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40 hidden p-4 transition-opacity duration-300 opacity-0">
    <div id="modal-content-wrapper" class="bg-white p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-xs sm:max-w-sm transform transition-all duration-300 ease-out scale-95 opacity-0">

        <!-- TELA INICIAL DO MODAL COM OP√á√ïES -->
        <div id="modal-initial-view">
            <div class="flex justify-between items-center mb-5">
                <h4 class="text-xl font-semibold text-gray-800">A√±adir Nuevo</h4>
                <button id="close-add-modal-btn" class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="space-y-3">
                <button data-form="gasto-variavel" class="modal-choice-btn flex items-center w-full text-left px-4 py-3 bg-red-50 text-red-700 hover:bg-red-100 rounded-lg transition duration-150 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                    </svg>
                    Gasto Variable
                </button>

                <button data-form="gasto-fixo" class="modal-choice-btn flex items-center w-full text-left px-4 py-3 bg-orange-50 text-orange-700 hover:bg-orange-100 rounded-lg transition duration-150 ease-in-out" title="A√±adir un gasto recurrente">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-orange-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10v8a2 2 0 002-2V6a2 2 0 00-2-2H4z" clip-rule="evenodd" />
                        <path d="M6 12a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4z" />
                    </svg>
                    Gasto Fijo
                </button>

                <button data-form="outra-receita" class="modal-choice-btn flex items-center w-full text-left px-4 py-3 bg-green-50 text-green-700 hover:bg-green-100 rounded-lg transition duration-150 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                    </svg>
                    Otro Ingreso
                </button>

                <button data-form="lembrete" class="modal-choice-btn flex items-center w-full text-left px-4 py-3 bg-amber-50 text-amber-700 hover:bg-amber-100 rounded-lg transition duration-150 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-amber-600" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
                    </svg>
                    Recordatorio
                </button>

                <button onclick="abrirModalMeta(metaAtivaParaModal ? true : false)" class="modal-choice-btn flex items-center w-full text-left px-4 py-3 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 rounded-lg transition duration-150 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    Definir/Editar Meta
                </button>
            </div>
        </div>

        <!-- FORMUL√ÅRIO GASTO VARI√ÅVEL -->
        <div id="modal-form-gasto-variavel" class="hidden">
            <div class="relative flex items-center justify-center mb-4 pb-2 border-b border-gray-200">
                <button class="modal-back-btn absolute left-0 text-[#55d83f] hover:text-[#065428] font-medium text-sm flex items-center p-1 -ml-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h5 class="text-lg font-semibold text-gray-700 text-center">A√±adir Gasto Variable</h5>
            </div>
            <form action="{{ url_for('add_gasto') }}" method="POST" class="space-y-4">
                <input type="hidden" name="tipo_gasto_ativo" value="variaveis">
                <div>
                    <label for="gasto-descricao" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                    <input type="text" id="gasto-descricao" name="descricao" required placeholder="Ej: Almuerzo" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="gasto-valor" class="block text-sm font-medium text-gray-700 mb-1">Valor ($)</label>
                        <input type="number" step="0.01" id="gasto-valor" name="valor" required placeholder="25.50" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                    </div>
                    <div>
                        <label for="gasto-data" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="gasto-data" name="data" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                    </div>
                </div>
                <div>
                    <label for="gasto-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                    <select id="gasto-categoria" name="categoria" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-10">
                        <option value="" disabled selected>Selecciona...</option>
                        {% for cat_var in categorias_por_tipo.gasto_variavel %}
                        <option value="{{ cat_var }}">{{ cat_var }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="w-full bg-[#55d83f] text-white py-2.5 px-4 rounded-lg hover:bg-[#47b333] text-sm font-medium h-10">A√±adir Gasto</button>
            </form>
        </div>

        <!-- FORMUL√ÅRIO GASTO FIXO -->
        <div id="modal-form-gasto-fixo" class="hidden">
            <div class="relative flex items-center justify-center mb-4 pb-2 border-b border-gray-200">
                <button class="modal-back-btn absolute left-0 text-[#55d83f] hover:text-[#065428] font-medium text-sm flex items-center p-1 -ml-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h5 class="text-lg font-semibold text-gray-700 text-center">A√±adir Gasto Fijo</h5>
            </div>
            <form action="{{ url_for('add_gasto_fixo') }}" method="POST" class="space-y-4">
                <div>
                    <label for="fixo-descricao" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                    <input type="text" id="fixo-descricao" name="descricao_fixo" required placeholder="Ej: Suscripci√≥n Netflix" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="fixo-valor" class="block text-sm font-medium text-gray-700 mb-1">Valor ($)</label>
                        <input type="number" step="0.01" id="fixo-valor" name="valor_fixo" required placeholder="55.90" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                    </div>
                    <div>
                        <label for="fixo-fecha-inicio" class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                        <input type="date" id="fixo-fecha-inicio" name="fecha_inicio_fixo" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                    </div>
                </div>
                <div>
                    <label for="fixo-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                    <select id="fixo-categoria" name="categoria_fixo" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-10">
                        <option value="" disabled selected>Selecciona...</option>
                        {% for cat_fixo in categorias_por_tipo.gasto_fixo %}
                        <option value="{{ cat_fixo }}">{{ cat_fixo }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="fixo-recurrencia" class="block text-sm font-medium text-gray-700 mb-1">Recurrencia</label>
                        <select id="fixo-recurrencia" name="recurrencia_fixo" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-10">
                            <option value="mensal" selected>Mensual</option>
                         
                            <option value="unico">√önico</option>
                        </select>
                    </div>
                    <div class="flex items-center pt-6">
                        <input id="fixo-activo" name="activo_fixo" type="checkbox" checked class="h-5 w-5 text-[#55d83f] border-gray-300 rounded focus:ring-[#55d83f]">
                        <label for="fixo-activo" class="ml-2 block text-sm text-gray-900">Activo</label>
                    </div>
                </div>
                <button type="submit" class="w-full bg-[#55d83f] text-white py-2.5 px-4 rounded-lg hover:bg-[#47b333] text-sm font-medium h-10">A√±adir Gasto Fijo</button>
            </form>
        </div>

        <!-- FORMUL√ÅRIO OUTRA RECEITA -->
        <div id="modal-form-outra-receita" class="hidden">
            <div class="relative flex items-center justify-center mb-4 pb-2 border-b border-gray-200">
                <button class="modal-back-btn absolute left-0 text-[#55d83f] hover:text-[#065428] font-medium text-sm flex items-center p-1 -ml-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h5 class="text-lg font-semibold text-gray-700 text-center">A√±adir Otro Ingreso</h5>
            </div>
            <form action="{{ url_for('add_outra_receita') }}" method="POST" class="space-y-4">
                <div>
                    <label for="or-descricao" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                    <input type="text" id="or-descricao" name="descricao_outra_receita" required placeholder="Ej: Venta de producto" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="or-valor" class="block text-sm font-medium text-gray-700 mb-1">Valor ($)</label>
                        <input type="number" step="0.01" id="or-valor" name="valor_outra_receita" required placeholder="150.00" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                    </div>
                    <div>
                        <label for="or-data" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="or-data" name="data_outra_receita" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                    </div>
                </div>
                <div>
                    <label for="or-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                    <select id="or-categoria" name="categoria_outra_receita" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-10">
                        <option value="" disabled selected>Selecciona...</option>
                        {% for cat_rec in categorias_por_tipo.receita %}
                        <option value="{{ cat_rec }}">{{ cat_rec }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="w-full bg-[#55d83f] text-white py-2.5 px-4 rounded-lg hover:bg-[#47b333] text-sm font-medium h-10">A√±adir Ingreso</button>
            </form>
        </div>

        <!-- FORMUL√ÅRIO LEMBRETE -->
        <div id="modal-form-lembrete" class="hidden">
             <div class="relative flex items-center justify-center mb-4 pb-2 border-b border-gray-200">
                 <button class="modal-back-btn absolute left-0 text-[#55d83f] hover:text-[#065428] font-medium text-sm flex items-center p-1 -ml-1">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                 </button>
                 <h5 class="text-lg font-semibold text-gray-700 text-center">A√±adir Recordatorio</h5>
             </div>
            <form id="form-add-lembrete-dashboard" action="{{ url_for('add_lembrete_from_modal') }}" method="POST" class="space-y-4">
                <div>
                    <label for="lembrete-descricao-dashboard" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
                    <input type="text" id="lembrete-descricao-dashboard" name="descricao_lembrete" required placeholder="Ej: Pagar factura de luz" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="lembrete-data-dashboard" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                        <input type="date" id="lembrete-data-dashboard" name="data_lembrete" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10">
                    </div>
                    <div>
                        <label for="lembrete-repetir-dashboard" class="block text-sm font-medium text-gray-700 mb-1">¬øRepetir?</label>
                        <select id="lembrete-repetir-dashboard" name="repetir_lembrete" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-10">
                            <option value="false" selected>No</option>
                            <option value="true">S√≠</option>
                        </select>
                    </div>
                </div>
                <div id="campo-tipo-repeticao-dashboard" class="hidden">
                    <label for="lembrete-tipo-rep-dashboard" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Repetici√≥n</label>
                    <select id="lembrete-tipo-rep-dashboard" name="tipo_repeticion_lembrete" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-10">
                        <option value="mensal" selected>Mensual</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-[#55d83f] text-white py-2.5 px-4 rounded-lg hover:bg-[#47b333] text-sm font-medium h-10">A√±adir Recordatorio</button>
            </form>
        </div>

        <!-- FORMUL√ÅRIO META -->
        <div id="modal-form-meta" class="hidden">
            <div class="relative flex items-center justify-center mb-4 pb-2 border-b border-gray-200">
                <button class="modal-back-btn absolute left-0 text-[#55d83f] hover:text-[#065428] font-medium text-sm flex items-center p-1 -ml-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                <h5 id="modal-meta-titulo" class="text-lg font-semibold text-gray-700 text-center">Definir Meta Financiera</h5>
            </div>
            <form action="{{ url_for('metas') }}" method="POST" class="space-y-4">
                <div>
                    <label for="modal_meta_descricao" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n de la Meta</label>
                    <input type="text" name="meta_descricao" id="modal_meta_descricao" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10" placeholder="Ej: Viaje a Europa">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="modal_meta_categoria" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
                        <select name="meta_categoria" id="modal_meta_categoria" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-10">
                            <option value="" disabled selected>Selecciona...</option>
                            <option value="Viagem">Viaje</option>
                            <option value="Compra">Compra</option>
                            <option value="Guardar dinheiro">Ahorrar dinero</option>
                            <option value="Outros">Otros</option>
                        </select>
                    </div>
                    <div>
                        <label for="modal_meta_valor_alvo" class="block text-sm font-medium text-gray-700 mb-1">Valor Objetivo ($)</label>
                        <input type="number" name="meta_valor_alvo" id="modal_meta_valor_alvo" step="0.01" min="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] h-10" placeholder="10000.00">
                    </div>
                </div>
                <div>
                    <label for="modal_meta_prazo" class="block text-sm font-medium text-gray-700 mb-1">Plazo</label>
                    <select name="meta_prazo" id="modal_meta_prazo" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-10">
                        <option value="indefinido" selected>Indefinido (solo ahorrar)</option>
                        <option value="1">1 mes</option>
                        <option value="3">3 meses</option>
                        <option value="6">6 meses</option>
                        <option value="12">12 meses (1 a√±o)</option>
                        <option value="18">18 meses</option>
                        <option value="24">24 meses (2 a√±os)</option>
                        <option value="36">36 meses (3 a√±os)</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" class="modal-back-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none h-10 transition-colors">Cancelar</button>
                    <button type="submit" id="modal-meta-submit-btn" class="px-4 py-2 text-sm font-medium text-white bg-[#55d83f] rounded-lg hover:bg-[#47b333] focus:outline-none h-10 transition-colors">Guardar Meta</button>
                </div>
            </form>
        </div>
    </div>
</div>



    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

        if (typeof showSpecificViewInModal !== 'function') {
        console.log("Inicializando fun√ß√µes para o modal do dashboard");
        
        // Fun√ß√µes para controle do Modal
        let addItemModal = document.getElementById('add-item-modal');
        let modalContentWrapper = document.getElementById('modal-content-wrapper');
        let initialView = document.getElementById('modal-initial-view');
        let formGastoVariavel = document.getElementById('modal-form-gasto-variavel');
        let formGastoFixo = document.getElementById('modal-form-gasto-fixo');
        let formOutraReceita = document.getElementById('modal-form-outra-receita');
        let formLembrete = document.getElementById('modal-form-lembrete'); 
        let formMeta = document.getElementById('modal-form-meta');
        let allModalViews = [initialView, formGastoVariavel, formGastoFixo, formOutraReceita, formLembrete, formMeta].filter(v => v != null);
        let metaAtivaParaModal = null;
        
        // Definir a meta ativa para o modal, se houver
        {% if meta_ativa and meta_ativa.status == 'ativa' %}
            metaAtivaParaModal = {{ meta_ativa | tojson | safe }};
        {% endif %}

        function showSpecificViewInModal(viewToShow) {
            console.log("Fun√ß√£o showSpecificViewInModal chamada");
            if (!allModalViews) {
                console.error("Modal views array not initialized yet.");
                return;
            }
            
            // Esconde todas as views
            allModalViews.forEach(view => {
                if(view) view.classList.add('hidden');
            });
            
            // Mostra a view especificada
            if (viewToShow) {
                viewToShow.classList.remove('hidden');
                console.log("View mostrada:", viewToShow.id);
                
                // Define datas padr√£o para os formul√°rios
                if (viewToShow === formGastoVariavel) setDefaultDate('gasto-data');
                if (viewToShow === formGastoFixo) setDefaultDate('fixo-fecha-inicio');
                if (viewToShow === formOutraReceita) setDefaultDate('or-data');
                if (viewToShow === formLembrete) setDefaultDate('lembrete-data-dashboard');
            } else {
                console.warn("Tentativa de mostrar view nula no modal.");
            }
        }

        function openModalContainer() {
            console.log("Fun√ß√£o openModalContainer chamada");
            if (addItemModal && modalContentWrapper) {
                if (initialView) showSpecificViewInModal(initialView);
                addItemModal.classList.remove('hidden');
                setTimeout(() => {
                    addItemModal.classList.remove('opacity-0');
                    modalContentWrapper.classList.remove('opacity-0', 'scale-95');
                    modalContentWrapper.classList.add('opacity-100', 'scale-100');
                }, 10);
            } else {
                console.error("Erro: Elementos do modal principal n√£o encontrados ao tentar abrir!");
            }
        }

        function closeModalContainer() {
            console.log("Fun√ß√£o closeModalContainer chamada");
            if (addItemModal && modalContentWrapper) {
                modalContentWrapper.classList.remove('opacity-100', 'scale-100');
                modalContentWrapper.classList.add('opacity-0', 'scale-95');
                addItemModal.classList.add('opacity-0');
                setTimeout(() => {
                    addItemModal.classList.add('hidden');
                    if (initialView) showSpecificViewInModal(initialView);
                    resetLembreteFormDashboard();
                }, 300);
            } else {
                console.error("Erro: Elementos do modal principal n√£o encontrados ao tentar fechar!");
            }
        }

        function abrirModalMeta(ehParaEditar) {
            console.log("Fun√ß√£o abrirModalMeta chamada");
            const modalTitulo = document.getElementById('modal-meta-titulo');
            const modalSubmitBtn = document.getElementById('modal-meta-submit-btn');
            const descInput = document.getElementById('modal_meta_descricao');
            const catSelect = document.getElementById('modal_meta_categoria');
            const valorInput = document.getElementById('modal_meta_valor_alvo');
            const prazoSelect = document.getElementById('modal_meta_prazo');

            if (!formMeta || !modalTitulo || !modalSubmitBtn || !descInput || !catSelect || !valorInput || !prazoSelect) {
                console.error("Elementos do modal de meta n√£o encontrados!");
                return;
            }

            if (ehParaEditar && metaAtivaParaModal) {
                modalTitulo.textContent = 'Editar Meta Financiera';
                modalSubmitBtn.textContent = 'Actualizar Meta';
                descInput.value = metaAtivaParaModal.descricao || '';
                catSelect.value = metaAtivaParaModal.categoria || '';
                valorInput.value = metaAtivaParaModal.valor_alvo || '';
                prazoSelect.value = metaAtivaParaModal.prazo_meses ? String(metaAtivaParaModal.prazo_meses) : 'indefinido';
            } else {
                modalTitulo.textContent = 'Definir Nueva Meta Financiera';
                modalSubmitBtn.textContent = 'Guardar Nueva Meta';
                descInput.value = '';
                catSelect.value = '';
                valorInput.value = '';
                prazoSelect.value = 'indefinido';
            }
            
            showSpecificViewInModal(formMeta);
            
            if (addItemModal && addItemModal.classList.contains('hidden')) {
                addItemModal.classList.remove('hidden');
                setTimeout(() => {
                    addItemModal.classList.remove('opacity-0');
                    if (modalContentWrapper) {
                        modalContentWrapper.classList.remove('opacity-0', 'scale-95');
                        modalContentWrapper.classList.add('opacity-100', 'scale-100');
                    }
                }, 10);
            } else if (!addItemModal || !modalContentWrapper) {
                console.error("Erro: Elementos do modal principal n√£o encontrados ao abrir form de meta!");
            }
        }

        function resetLembreteFormDashboard() {
            console.log("Fun√ß√£o resetLembreteFormDashboard chamada");
            const form = document.getElementById('form-add-lembrete-dashboard');
            const repetirSelectDashboard = document.getElementById('lembrete-repetir-dashboard');
            const tipoRepeticaoDivDashboard = document.getElementById('campo-tipo-repeticao-dashboard');
            const dataLembreteInputDashboard = document.getElementById('lembrete-data-dashboard');

            if (form) {
                form.reset();
            }
            
            if(dataLembreteInputDashboard) {
                setDefaultDate('lembrete-data-dashboard');
            }
            
            if(repetirSelectDashboard) {
                repetirSelectDashboard.value = 'false';
            }
            
            if(tipoRepeticaoDivDashboard) {
                tipoRepeticaoDivDashboard.classList.add('hidden');
            }
            
            if(repetirSelectDashboard) {
                repetirSelectDashboard.dispatchEvent(new Event('change'));
            }
        }

        // Configura√ß√£o de eventos quando o documento estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM completamente carregado para o script do modal.");
            
            // Redefine refer√™ncias para ter certeza de que est√£o atualizadas
            addItemModal = document.getElementById('add-item-modal');
            modalContentWrapper = document.getElementById('modal-content-wrapper');
            initialView = document.getElementById('modal-initial-view');
            formGastoVariavel = document.getElementById('modal-form-gasto-variavel');
            formGastoFixo = document.getElementById('modal-form-gasto-fixo');
            formOutraReceita = document.getElementById('modal-form-outra-receita');
            formLembrete = document.getElementById('modal-form-lembrete'); 
            formMeta = document.getElementById('modal-form-meta');
            allModalViews = [initialView, formGastoVariavel, formGastoFixo, formOutraReceita, formLembrete, formMeta].filter(v => v != null);
            
            console.log("Elementos do modal encontrados:", {
                modal: !!addItemModal,
                wrapper: !!modalContentWrapper,
                initialView: !!initialView,
                formGastoVariavel: !!formGastoVariavel,
                formGastoFixo: !!formGastoFixo,
                formOutraReceita: !!formOutraReceita,
                formLembrete: !!formLembrete,
                formMeta: !!formMeta
            });
            
            // Bot√µes do modal
            const openModalFabDesktop = document.getElementById('open-add-modal-fab');
            const closeModalBtn = document.getElementById('close-add-modal-btn');
            const modalChoiceBtns = document.querySelectorAll('.modal-choice-btn');
            const modalBackBtns = document.querySelectorAll('.modal-back-btn');
            
            // Inicializa l√≥gica para abrir o modal
            if (openModalFabDesktop) {
                openModalFabDesktop.addEventListener('click', openModalContainer);
                console.log("Evento de clique adicionado ao bot√£o de abrir modal");
            } else {
                console.warn("Bot√£o FAB Desktop (open-add-modal-fab) n√£o encontrado.");
            }
            
            // Inicializa l√≥gica para fechar o modal
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModalContainer);
                console.log("Evento de clique adicionado ao bot√£o de fechar modal");
            }
            
            // Fecha o modal ao clicar fora
            if (addItemModal) {
                addItemModal.addEventListener('click', (event) => {
                    if (event.target === addItemModal) {
                        closeModalContainer();
                    }
                });
            }
            
            // Configura bot√µes de escolha no modal inicial
            console.log("Configurando", modalChoiceBtns.length, "bot√µes de escolha do modal");
            modalChoiceBtns.forEach((btn, index) => {
                btn.addEventListener('click', function() {
                    console.log("Bot√£o de escolha clicado:", this.dataset.form);
                    const formType = this.dataset.form;
                    if (formType === 'gasto-variavel') showSpecificViewInModal(formGastoVariavel);
                    else if (formType === 'gasto-fixo') showSpecificViewInModal(formGastoFixo);
                    else if (formType === 'outra-receita') showSpecificViewInModal(formOutraReceita);
                    else if (formType === 'lembrete') {
                        if(formLembrete) {
                            resetLembreteFormDashboard();
                            showSpecificViewInModal(formLembrete);
                        }
                        else {
                            console.error("Elemento do formul√°rio de Lembrete n√£o encontrado!");
                        }
                    }
                    else if (formType !== 'meta') {
                        console.warn("Tipo de formul√°rio desconhecido:", formType);
                    }
                });
            });
            
            // Configura bot√µes de voltar
            console.log("Configurando", modalBackBtns.length, "bot√µes de voltar");
            modalBackBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log("Bot√£o de voltar clicado");
                    const isInMetaForm = btn.closest('#modal-form-meta');
                    if (isInMetaForm) {
                        closeModalContainer();
                    }
                    else if (initialView) {
                        showSpecificViewInModal(initialView);
                    }
                    else {
                        closeModalContainer();
                    }
                });
            });
            
            // Configura l√≥gica de repeti√ß√£o de lembrete
            const repetirSelectDashboard = document.getElementById('lembrete-repetir-dashboard');
            const tipoRepeticaoDivDashboard = document.getElementById('campo-tipo-repeticao-dashboard');
            
            if (repetirSelectDashboard && tipoRepeticaoDivDashboard) {
                repetirSelectDashboard.addEventListener('change', () => {
                    tipoRepeticaoDivDashboard.classList.toggle('hidden', repetirSelectDashboard.value !== 'true');
                });
                tipoRepeticaoDivDashboard.classList.toggle('hidden', repetirSelectDashboard.value !== 'true');
            } else {
                console.warn("Elementos de repeti√ß√£o do lembrete do dashboard n√£o encontrados.");
            }
            
            console.log("Configura√ß√£o do modal conclu√≠da com sucesso.");
        });
    } else {
        console.log("As fun√ß√µes do modal j√° est√£o definidas, pulando inicializa√ß√£o.");
    }
    // Fun√ß√µes auxiliares globais para o template
    function formatCurrencyJS(value) {
        const numValue = Number(value);
        if (isNaN(numValue)) { return '$ -'; }
        // CORRE√á√ÉO APLICADA: Formata√ß√£o completa para MXN
        return numValue.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
    }
    function setDefaultDate(inputId) {
        const dateInput = document.getElementById(inputId);
        if (dateInput && !dateInput.value) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        }
    }



    

    // Sauda√ß√£o din√¢mica
    function setGreeting() {
        const greetingSpan = document.getElementById('dynamic-greeting');
        if (!greetingSpan) return;

        const hour = new Date().getHours();
        if (hour < 12) {
            greetingSpan.textContent = 'Buenos d√≠as';
        } else if (hour < 18) {
            greetingSpan.textContent = 'Buenas tardes';
        } else {
            greetingSpan.textContent = 'Buenas noches';
        }
    }

    // Fun√ß√µes globais para controle do Modal Principal
    let addItemModal, modalContentWrapper, initialView, formGastoVariavel, formGastoFixo, formOutraReceita, formLembrete, formMeta, allModalViews;
    let metaAtivaParaModal = null;
    {% if meta_ativa and meta_ativa.status == 'ativa' %}
        metaAtivaParaModal = {{ meta_ativa | tojson | safe }};
    {% endif %}

    function showSpecificViewInModal(viewToShow) {
        if (!allModalViews) { console.error("Modal views array not initialized yet."); return; }
        allModalViews.forEach(view => { if(view) view.classList.add('hidden'); });
        if (viewToShow) {
            viewToShow.classList.remove('hidden');
            if (viewToShow === formGastoVariavel) setDefaultDate('gasto-data');
            if (viewToShow === formGastoFixo) setDefaultDate('fixo-fecha-inicio');
            if (viewToShow === formOutraReceita) setDefaultDate('or-data');
            if (viewToShow === formLembrete) setDefaultDate('lembrete-data-dashboard');
        } else { console.warn("Tentativa de mostrar view nula no modal."); }
    }

    function openModalContainer() {
        if (addItemModal && modalContentWrapper) {
            if (initialView) showSpecificViewInModal(initialView); 
            addItemModal.classList.remove('hidden');
            setTimeout(() => {
                addItemModal.classList.remove('opacity-0');
                modalContentWrapper.classList.remove('opacity-0', 'scale-95');
                modalContentWrapper.classList.add('opacity-100', 'scale-100');
            }, 10);
        } else { console.error("Erro: Elementos do modal principal n√£o encontrados ao tentar abrir!"); }
    }

    function closeModalContainer() {
        if (addItemModal && modalContentWrapper) {
            modalContentWrapper.classList.remove('opacity-100', 'scale-100');
            modalContentWrapper.classList.add('opacity-0', 'scale-95');
            addItemModal.classList.add('opacity-0');
            setTimeout(() => {
                addItemModal.classList.add('hidden');
                if (initialView) showSpecificViewInModal(initialView); 
                resetLembreteFormDashboard(); 
            }, 300);
        } else { console.error("Erro: Elementos do modal principal n√£o encontrados ao tentar fechar!"); }
    }

     function abrirModalMeta(ehParaEditar) {
        const modalTitulo = document.getElementById('modal-meta-titulo');
        const modalSubmitBtn = document.getElementById('modal-meta-submit-btn');
        const descInput = document.getElementById('modal_meta_descricao');
        const catSelect = document.getElementById('modal_meta_categoria');
        const valorInput = document.getElementById('modal_meta_valor_alvo');
        const prazoSelect = document.getElementById('modal_meta_prazo');

        if (!formMeta || !modalTitulo || !modalSubmitBtn || !descInput || !catSelect || !valorInput || !prazoSelect) {
            console.error("Elementos do modal de meta n√£o encontrados!");
            return;
        }

        if (ehParaEditar && metaAtivaParaModal) {
            modalTitulo.textContent = 'Editar Meta Financiera';
            modalSubmitBtn.textContent = 'Actualizar Meta';
            descInput.value = metaAtivaParaModal.descricao || '';
            catSelect.value = metaAtivaParaModal.categoria || '';
            valorInput.value = metaAtivaParaModal.valor_alvo || '';
            prazoSelect.value = metaAtivaParaModal.prazo_meses ? String(metaAtivaParaModal.prazo_meses) : 'indefinido';
        } else {
            modalTitulo.textContent = 'Definir Nueva Meta Financiera';
            modalSubmitBtn.textContent = 'Guardar Nueva Meta';
            descInput.value = '';
            catSelect.value = '';
            valorInput.value = '';
            prazoSelect.value = 'indefinido';
        }
        showSpecificViewInModal(formMeta);
        if (addItemModal && addItemModal.classList.contains('hidden')) {
             addItemModal.classList.remove('hidden');
             setTimeout(() => {
                 addItemModal.classList.remove('opacity-0');
                 if (modalContentWrapper) { 
                     modalContentWrapper.classList.remove('opacity-0', 'scale-95');
                     modalContentWrapper.classList.add('opacity-100', 'scale-100');
                 }
             }, 10);
        } else if (!addItemModal || !modalContentWrapper) {
             console.error("Erro: Elementos do modal principal n√£o encontrados ao abrir form de meta!");
        }
    }

    const confirmCancelModal = document.getElementById('confirm-cancel-meta-modal');

    function openConfirmCancelModal() {
        if (confirmCancelModal) {
            confirmCancelModal.classList.remove('hidden');
            setTimeout(() => confirmCancelModal.classList.remove('opacity-0'), 10);
        } else {
            console.error("Modal de confirma√ß√£o de cancelamento n√£o encontrado!");
        }
    }

    function closeConfirmCancelModal() {
        if (confirmCancelModal) {
            confirmCancelModal.classList.add('opacity-0');
            setTimeout(() => confirmCancelModal.classList.add('hidden'), 300);
        }
    }

    function submitCancelMetaForm() {
        const form = document.getElementById('cancel-meta-form');
        if (form) {
            form.submit();
        } else {
            console.error("Formul√°rio de cancelamento de meta n√£o encontrado!");
            closeConfirmCancelModal(); 
        }
    }

    function resetLembreteFormDashboard() {
        const form = document.getElementById('form-add-lembrete-dashboard');
        const repetirSelectDashboard = document.getElementById('lembrete-repetir-dashboard');
        const tipoRepeticaoDivDashboard = document.getElementById('campo-tipo-repeticao-dashboard');
        const dataLembreteInputDashboard = document.getElementById('lembrete-data-dashboard');

        if (form) {
            form.reset(); 
        }
        if(dataLembreteInputDashboard) { 
             setDefaultDate('lembrete-data-dashboard');
        }
        if(repetirSelectDashboard) {
            repetirSelectDashboard.value = 'false'; 
        }
        if(tipoRepeticaoDivDashboard) {
            tipoRepeticaoDivDashboard.classList.add('hidden'); 
        }
        if(repetirSelectDashboard) {
             repetirSelectDashboard.dispatchEvent(new Event('change'));
        }
    }


    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM completamente carregado. Inicializando scripts do dashboard...");
        setGreeting(); 

        addItemModal = document.getElementById('add-item-modal');
        modalContentWrapper = document.getElementById('modal-content-wrapper');
        initialView = document.getElementById('modal-initial-view');
        formGastoVariavel = document.getElementById('modal-form-gasto-variavel');
        formGastoFixo = document.getElementById('modal-form-gasto-fixo');
        formOutraReceita = document.getElementById('modal-form-outra-receita');
        formLembrete = document.getElementById('modal-form-lembrete'); 
        formMeta = document.getElementById('modal-form-meta');
        allModalViews = [initialView, formGastoVariavel, formGastoFixo, formOutraReceita, formLembrete, formMeta].filter(v => v != null);

        try {
            console.log("Tentando inicializar gr√°ficos...");
            let dadosFlaskGraficos = {};
            try {
                const dadosJsonRaw = '{{ dados_json | default("{}") | safe }}';
                console.log("Dados JSON recebidos para gr√°ficos:", dadosJsonRaw);
                if (dadosJsonRaw && dadosJsonRaw !== '{}') {
                    dadosFlaskGraficos = JSON.parse(dadosJsonRaw);
                    console.log("Conte√∫do de dadosFlaskGraficos:", dadosFlaskGraficos);
                } else {
                    console.warn("Dados JSON para gr√°ficos est√£o vazios ou ausentes.");
                    dadosFlaskGraficos = { gastos_categoria_labels: [], gastos_categoria_data: [], gastos_tempo_labels: [], gastos_tempo_data: []};
                }
            } catch (e) {
                console.error("Erro ao parsear dados JSON para gr√°ficos:", e);
                dadosFlaskGraficos = { gastos_categoria_labels: [], gastos_categoria_data: [], gastos_tempo_labels: [], gastos_tempo_data: []};
            }

            const ctxCategoria = document.getElementById('graficoGastosCategoria')?.getContext('2d');
            if (ctxCategoria) {
                const hasCategoriaData = dadosFlaskGraficos.gastos_categoria_labels && Array.isArray(dadosFlaskGraficos.gastos_categoria_labels) && dadosFlaskGraficos.gastos_categoria_labels.length > 0 &&
                                         dadosFlaskGraficos.gastos_categoria_data && Array.isArray(dadosFlaskGraficos.gastos_categoria_data) && dadosFlaskGraficos.gastos_categoria_data.length > 0;
                if (hasCategoriaData) {
                    try {
                        if (window.graficoGastosCategoria instanceof Chart) window.graficoGastosCategoria.destroy();
                        window.graficoGastosCategoria = new Chart(ctxCategoria, {
                            type: 'doughnut',
                            data: {
                                labels: dadosFlaskGraficos.gastos_categoria_labels,
                                datasets: [{
                                    label: 'Gastos por Categor√≠a', data: dadosFlaskGraficos.gastos_categoria_data,
                                    backgroundColor: ['#55d83f', '#b7ed51', '#065428', '#84cc16', '#4ade80', '#34d399', '#f59e0b', '#fbbf24', '#fde047'],
                                    borderColor: '#ffffff', borderWidth: 2, hoverOffset: 8
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false, cutout: '65%',
                                animation: { duration: 500 }, 
                                plugins: { legend: { position: 'bottom', labels: { padding: 15, boxWidth: 12, font: { size: 11, family: 'Manrope' } } }, tooltip: { callbacks: { label: (context) => `${context.label || ''}: ${formatCurrencyJS(context.parsed)}` }, titleFont: { family: 'Manrope' }, bodyFont: { family: 'Manrope' } } }
                            }
                        });
                    } catch (chartError) { console.error("Erro ao inicializar Chart.js (Categoria):", chartError); }
                } else {
                    const containerCat = ctxCategoria.canvas.parentElement;
                    if (containerCat) containerCat.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-center"><span class="text-3xl mb-2">ü§∑‚Äç‚ôÄÔ∏è</span><p class="text-gray-500 text-sm">Sin datos de gastos por categor√≠a para mostrar este mes.</p></div>';
                }
            } else { console.warn("Elemento canvas 'graficoGastosCategoria' n√£o encontrado."); }

            const ctxTempo = document.getElementById('graficoGastosTempo')?.getContext('2d');
            if (ctxTempo) {
                const hasTempoData = dadosFlaskGraficos.gastos_tempo_labels && Array.isArray(dadosFlaskGraficos.gastos_tempo_labels) && dadosFlaskGraficos.gastos_tempo_labels.length > 0 &&
                                   dadosFlaskGraficos.gastos_tempo_data && Array.isArray(dadosFlaskGraficos.gastos_tempo_data) && dadosFlaskGraficos.gastos_tempo_data.length > 0;
                
                if (hasTempoData) {
                     try {
                        if (window.graficoGastosTempo instanceof Chart) {
                            window.graficoGastosTempo.destroy(); // Destr√≥i o gr√°fico antigo se existir
                        }

                        // Criando o degrad√™ para o fundo da linha
                        let gradientFill = ctxTempo.createLinearGradient(0, 0, 0, ctxTempo.canvas.height);
                        gradientFill.addColorStop(0, 'rgba(132, 204, 22, 0.4)'); // Cor lima mais forte em cima (com transpar√™ncia)
                        gradientFill.addColorStop(1, 'rgba(132, 204, 22, 0.05)');// Cor lima mais fraca embaixo (bem transparente)

                        window.graficoGastosTempo = new Chart(ctxTempo, {
                            type: 'line', // MUDADO PARA LINHA
                            data: {
                                labels: dadosFlaskGraficos.gastos_tempo_labels, // Vem do backend
                                datasets: [{
                                    label: 'Gasto Diario', 
                                    data: dadosFlaskGraficos.gastos_tempo_data, // Vem do backend
                                    fill: true, // Preenche a √°rea abaixo da linha
                                    backgroundColor: gradientFill, // Usa o degrad√™ criado
                                    borderColor: '#84cc16', // Cor da linha (um tom de verde/lima)
                                    borderWidth: 2.5, // Espessura da linha
                                    tension: 0.4, // Suaviza as curvas da linha
                                    pointRadius: dadosFlaskGraficos.gastos_tempo_labels.length > 15 ? 0 : 3, // Esconde pontos se muitos dias
                                    pointBackgroundColor: '#84cc16',
                                    pointBorderColor: '#fff',
                                    pointHoverRadius: 5,
                                    pointHoverBackgroundColor: '#84cc16',
                                }]
                            },
                            options: {
                                responsive: true, 
                                maintainAspectRatio: false, // Importante para o wrapper de scroll
                                animation: { duration: 500 },
                                scales: {
                                    y: { 
                                        beginAtZero: true, 
                                        ticks: { 
                                            callback: (value) => formatCurrencyJS(value), // Sua fun√ß√£o de formatar moeda
                                            font: { family: 'Manrope'} 
                                        }, 
                                        grid: { 
                                            display: true, 
                                            color: "rgba(0, 0, 0, 0.05)" 
                                        } 
                                    },
                                    x: { 
                                        grid: { 
                                            display: false 
                                        }, 
                                        ticks: { 
                                            font: { family: 'Manrope'},
                                            autoSkip: true, // Deixa o Chart.js pular alguns labels se ficarem apertados
                                            maxRotation: 0, // Evita que os labels girem se forem muitos
                                            minRotation: 0
                                        }
                                    }
                                },
                                plugins: { 
                                    legend: { 
                                        display: false // Geralmente n√£o precisa de legenda para um √∫nico dataset
                                    }, 
                                    tooltip: { 
                                        callbacks: { 
                                            label: (context) => `${context.dataset.label || ''}: ${formatCurrencyJS(context.parsed.y)}` 
                                        }, 
                                        backgroundColor: '#065428', 
                                        titleFont: { size: 14, weight: 'bold', family: 'Manrope'}, 
                                        bodyFont: { size: 12, family: 'Manrope' }, 
                                        padding: 10, 
                                        cornerRadius: 6, 
                                        displayColors: false 
                                    } 
                                }
                            }
                        });
                    } catch (chartError) { console.error("Erro ao inicializar Chart.js (Tempo):", chartError); }
                } else {
                    const containerTempo = ctxTempo.canvas.parentElement;
                    if (containerTempo) containerTempo.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-center"><span class="text-3xl mb-2">üìä</span><p class="text-gray-500 text-sm">Sin datos de gastos recientes para mostrar el gr√°fico de tiempo.</p></div>';
                }
            } else { console.warn("Elemento canvas 'graficoGastosTempo' n√£o encontrado."); }
        } catch (error) { console.error("Erro geral durante a inicializa√ß√£o dos gr√°ficos:", error); }

        const openModalFabDesktop = document.getElementById('open-add-modal-fab');
        const closeModalBtn = document.getElementById('close-add-modal-btn');
        const modalChoiceBtns = document.querySelectorAll('.modal-choice-btn');
        const modalBackBtns = document.querySelectorAll('.modal-back-btn');

        if (openModalFabDesktop) {
            openModalFabDesktop.addEventListener('click', openModalContainer);
        } else { console.warn("Bot√£o FAB Desktop (open-add-modal-fab) n√£o encontrado."); }

        if (closeModalBtn) { closeModalBtn.addEventListener('click', closeModalContainer); }

        if (addItemModal) {
            addItemModal.addEventListener('click', (event) => {
                if (event.target === addItemModal) { closeModalContainer(); }
            });
        }

        modalChoiceBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const formType = this.dataset.form;
                if (formType === 'gasto-variavel') showSpecificViewInModal(formGastoVariavel);
                else if (formType === 'gasto-fixo') showSpecificViewInModal(formGastoFixo);
                else if (formType === 'outra-receita') showSpecificViewInModal(formOutraReceita);
                else if (formType === 'lembrete') {
                     if(formLembrete) {
                         resetLembreteFormDashboard();
                         showSpecificViewInModal(formLembrete);
                     }
                     else { console.error("Elemento do formul√°rio de Lembrete n√£o encontrado!"); }
                }
                else if (formType !== 'meta') { 
                     console.warn("Tipo de formul√°rio desconhecido:", formType);
                }
            });
        });

        modalBackBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const isInMetaForm = btn.closest('#modal-form-meta');
                if (isInMetaForm) { closeModalContainer(); }
                else if (initialView) { showSpecificViewInModal(initialView); }
                else { closeModalContainer(); }
            });
        });

        const repetirSelectDashboard = document.getElementById('lembrete-repetir-dashboard');
        const tipoRepeticaoDivDashboard = document.getElementById('campo-tipo-repeticao-dashboard');

        if (repetirSelectDashboard && tipoRepeticaoDivDashboard) {
            repetirSelectDashboard.addEventListener('change', () => {
                tipoRepeticaoDivDashboard.classList.toggle('hidden', repetirSelectDashboard.value !== 'true');
            });
             tipoRepeticaoDivDashboard.classList.toggle('hidden', repetirSelectDashboard.value !== 'true');
        } else {
            console.warn("Elementos de repeti√ß√£o do lembrete do dashboard n√£o encontrados.");
        }

        const flashContainer = document.getElementById('flash-messages-container');
        if (flashContainer) {
            const successMessages = flashContainer.querySelectorAll('.flash-message-success');
            if (successMessages.length > 0) {
                const saldoCard = document.getElementById('saldo-card');
                if (saldoCard) {
                    saldoCard.classList.add('animate-pulse-bg-success');
                    setTimeout(() => saldoCard.classList.remove('animate-pulse-bg-success'), 1500);
                }
            }
        }

        console.log("Scripts do dashboard finalizados e corrigidos.");
    });
    </script>
{% endblock %}