{# Herda a estrutura do base.html #}
{% extends 'base.html' %}

{# Define o t√≠tulo espec√≠fico desta p√°gina #}
{% block title %}Administrar Ingresos - Mi App Fin{% endblock %} {# Traduzido #}

{% block head_style %}
{{ super() }}
<style>
    /* Estilos para os bot√µes de a√ß√£o inline (desktop) */
    .inline-action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.375rem; /* p-1.5 */
        margin-left: 0.25rem; /* ml-1 */
        color: #6b7280; /* text-gray-500 */
        background-color: transparent;
        border: none;
        border-radius: 9999px; /* rounded-full */
        cursor: pointer;
        transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out;
    }
    .inline-action-button:hover {
        background-color: #f3f4f6; /* hover:bg-gray-100 */
        color: #374151; /* hover:text-gray-700 */
    }
    .inline-action-button svg {
        width: 1rem; /* w-4 */
        height: 1rem; /* h-4 */
    }
    .inline-action-button.delete:hover {
        background-color: #fee2e2; /* hover:bg-red-100 */
        color: #b91c1c; /* hover:text-red-700 */
    }

    /* Estilo para modal de a√ß√µes mobile */
    #mobile-actions-receita-modal-content .action-button { /* ID espec√≠fico para receitas */
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        color: #374151; /* text-gray-700 */
        border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
    }
    #mobile-actions-receita-modal-content .action-button:last-child {
        border-bottom: none;
    }
    #mobile-actions-receita-modal-content .action-button svg {
        margin-right: 0.75rem;
        width: 1.25rem;
        height: 1.25rem;
    }
    #mobile-actions-receita-modal-content .action-button.delete {
        color: #dc2626; /* text-red-600 */
    }
    #mobile-actions-receita-modal-content .action-button.delete svg {
        color: #dc2626; /* text-red-600 */
    }

    /* Z-index para modais */
    .modal-overlay { z-index: 50; }
    .modal-content { z-index: 51; }

     /* Pagina√ß√£o (Estilos Mantidos) */
    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 1.5rem; /* mt-6 */
        padding-bottom: 1rem; /* Espa√ßo extra no final */
    }
    .pagination-controls a, .pagination-controls span { /* Alterado 'button' para 'a' */
        margin: 0 0.25rem; /* mx-1 */
        padding: 0.5rem 0.75rem; /* py-2 px-3 */
        border: 1px solid #d1d5db; /* border-gray-300 */
        background-color: white;
        color: #374151; /* text-gray-700 */
        border-radius: 0.375rem; /* rounded-md */
        font-size: 0.875rem;
        text-decoration: none; /* Garante que n√£o haja sublinhado */
        display: inline-block; /* Para padding funcionar corretamente */
        line-height: 1.25rem; /* Ajuste para alinhar texto verticalmente */
    }
    .pagination-controls a:not(.disabled):hover { /* Aplica hover apenas se n√£o estiver desabilitado */
        background-color: #f3f4f6; /* hover:bg-gray-100 */
    }
    .pagination-controls a.disabled { /* Classe para links desabilitados */
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none; /* Impede cliques */
    }
    .pagination-controls .page-number.active { /* Estilo para span ativo */
        background-color: #55d83f;
        color: black;
        border-color: #55d83f;
    }
    /* Removido ID espec√≠fico #page-info-display-receitas.active, usando apenas .page-number.active */
</style>
{% endblock %}

{# Conte√∫do principal da p√°gina de Receitas #}
{% block content_body %}
<div class="container mx-auto px-2 sm:px-4 md:px-6 py-8">

    {# Cabe√ßalho da P√°gina #}
    <div class="mb-8">
        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">üí∞ Administrar Ingresos</h2> {# Traduzido #}
        <p class="text-gray-600 mt-1">Visualiza tus fuentes de ingresos e historial de entradas.</p> {# Traduzido #}
    </div>

    {# Mensagens Flash #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6 space-y-3">
            {% for category, message in messages %}
                <div class="p-4 rounded-lg text-sm border
                    {% if category == 'danger' %} bg-red-100 text-red-700 border-red-200
                    {% elif category == 'success' %} bg-green-100 text-green-800 border-green-200
                    {% elif category == 'warning' %} bg-yellow-100 text-yellow-800 border-yellow-200
                    {% else %} bg-blue-100 text-blue-800 border-blue-200 {% endif %}"
                    role="alert">
                    {# A tradu√ß√£o de 'category|capitalize' depende do backend. Ex: 'Success' -> '√âxito' #}
                    <span class="font-medium">
                        {% if category == 'danger' %}Peligro
                        {% elif category == 'success' %}√âxito
                        {% elif category == 'warning' %}Advertencia
                        {% else %}{{ category|capitalize }}{% endif %}:
                    </span> {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# Grid para Resumo e Sal√°rio Principal (Sem altera√ß√µes aqui) #}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl shadow-lg border border-emerald-200 md:col-span-2"> 
            {# Adicionado md:col-span-2 para fazer este card ocupar o espa√ßo dos dois anteriores em telas m√©dias e maiores #}
            <h3 class="text-lg font-semibold text-emerald-800 mb-2">Ingresos Registrados este Mes</h3>
            <p class="text-4xl font-bold text-emerald-600 mb-1">
                {{ total_entradas_mes | currency }} {# Esta vari√°vel agora reflete o total das 'outras_receitas' do m√™s #}
            </p>
            <p class="text-xs text-emerald-700 opacity-80">(Suma de todas las entradas registradas en el mes actual)</p>
            {# As linhas que mostravam "Salario Principal:" e "Otros Ingresos (Mes):" foram removidas daqui 
               porque total_entradas_mes j√° √© o valor consolidado sem o antigo salario_principal da config. #}
        </div>
        {# O segundo card (o que tinha o formul√°rio para editar o "Salario Principal") FOI COMPLETAMENTE REMOVIDO daqui. #}
    </div>

    {# Bot√µes de A√ß√£o (Sem altera√ß√µes aqui) #}
    <div class="flex flex-col sm:flex-row justify-end items-center mb-4 gap-3 w-full">
        <button
            id="open-filter-receitas-modal-btn"
            class="w-full sm:w-auto bg-[#55d83f] hover:bg-[#47b333] text-black font-semibold py-2.5 px-4 sm:px-5 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-[#55d83f] focus:ring-opacity-75 flex items-center justify-center transition duration-150 ease-in-out text-sm sm:text-base">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 11.414V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.586L3.293 6.707A1 1 0 013 6V3zm3.707 4.707A1 1 0 017 7h6a1 1 0 01.707.293l-2.38 2.379a1 1 0 01-1.414 0L6.707 7.707z" clip-rule="evenodd" />
            </svg>
            Filtrar / Ordenar {# Mantido (ou 'Filtrar / Clasificar') #}
        </button>
        <button
            id="open-add-outra-receita-modal-btn"
            class="w-full sm:w-auto bg-[#55d83f] hover:bg-[#47b333] text-black font-semibold py-2.5 px-4 sm:px-5 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-[#55d83f] focus:ring-opacity-75 flex items-center justify-center transition duration-150 ease-in-out text-sm sm:text-base">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
            </svg>
            A√±adir Entrada {# Traduzido #}
        </button>
    </div>

    {# Se√ß√£o para Listar Outras Entradas (Hist√≥rico) - Adicionado mb-20 #}
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow border border-gray-200 mb-20">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Historial de Otras Entradas</h3> {# Traduzido #}
        <div class="overflow-x-auto">
            {# A tabela agora usa a vari√°vel 'outras_receitas' que cont√©m apenas os itens da p√°gina atual #}
            {% if outras_receitas %}
                <table class="min-w-full divide-y divide-gray-200" id="receitas-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sm:px-3 lg:px-6">Fecha</th> {# Traduzido #}
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sm:px-3 lg:px-6">Descripci√≥n</th> {# Traduzido #}
                            <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sm:px-3 lg:px-6">Categor√≠a</th> {# Traduzido #}
                            <th scope="col" class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sm:px-3 lg:px-6">Valor</th> {# Mantido #}
                            <th scope="col" class="hidden lg:table-cell px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sm:px-3 lg:px-6">Acciones</th> {# Traduzido #}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="receitas-table-body">
                        {% for receita in outras_receitas %} {# Loop sobre a lista paginada vinda do Flask #}
                            <tr class="table-row-receita hover:bg-gray-50 transition-colors duration-150 relative cursor-pointer lg:cursor-default"
                                data-item-id="{{ receita.id }}"
                                data-item-descricao="{{ receita.descripcion }}"
                                data-item-valor="{{ receita.valor }}"
                                data-item-categoria="{{ receita.categoria }}"
                                data-item-data="{{ receita.fecha | date('%Y-%m-%d') }}"
                                >
                                <td class="px-2 py-3 text-xs sm:px-3 lg:px-6 sm:text-sm whitespace-nowrap text-gray-600">{{ receita.fecha | date }}</td>
                                <td class="px-2 py-3 text-xs sm:px-3 lg:px-6 sm:text-sm font-medium text-gray-900" title="{{receita.descripcion}}">{{ receita.descripcion }}</td>
                                <td class="px-2 py-3 text-xs sm:px-3 lg:px-6 sm:text-sm text-gray-600 whitespace-nowrap">{{ receita.categoria }}</td>
                                <td class="px-2 py-3 text-xs sm:px-3 lg:px-6 sm:text-sm text-green-600 text-right font-medium whitespace-nowrap">{{ receita.valor | currency }}</td> {# Ajustar filtro |currency para MXN #}
                                <td class="hidden lg:table-cell px-2 py-3 text-xs sm:px-3 lg:px-6 whitespace-nowrap text-sm text-center">
                                    {# Bot√µes de a√ß√£o desktop continuam funcionando com JS dos modais #}
                                    <div class="flex items-center justify-center space-x-1">
                                        <button type="button" title="Editar" class="inline-action-button open-edit-receita-btn"> {# Mantido title #}
                                            <span class="sr-only">Editar</span> {# Mantido #}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                        </button>
                                        <button type="button" title="Eliminar" class="inline-action-button delete open-delete-receita-btn"> {# Traduzido title #}
                                            <span class="sr-only">Eliminar</span> {# Traduzido #}
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                 {# --- PAGINA√á√ÉO ATUALIZADA --- #}
                 {# Mostrada apenas se houver mais de uma p√°gina #}
                 <div id="pagination-controls-receitas-container" class="pagination-controls {% if total_pages <= 1 %}hidden{% endif %}">
                    {# Bot√£o Anterior #}
                    <a href="{{ url_for('receitas', page=current_page-1, **filtros_aplicados) if current_page > 1 else '#' }}"
                       class="{% if current_page <= 1 %}disabled{% endif %}"
                       aria-disabled="{{ 'true' if current_page <= 1 else 'false' }}">
                        &laquo; Anterior {# Mantido #}
                    </a>
                    {# Informa√ß√£o da P√°gina #}
                    <span id="page-info-display-receitas" class="page-number active">P√°gina {{ current_page }} de {{ total_pages }}</span> {# Mantido estrutura, "P√°gina" e "de" s√£o corretos #}
                    {# Bot√£o Pr√≥xima #}
                    <a href="{{ url_for('receitas', page=current_page+1, **filtros_aplicados) if current_page < total_pages else '#' }}"
                       class="{% if current_page >= total_pages %}disabled{% endif %}"
                       aria-disabled="{{ 'true' if current_page >= total_pages else 'false' }}">
                        Siguiente &raquo; {# Traduzido #}
                    </a>
                </div>
            {% else %}
                {# Mensagem se n√£o houver nenhuma receita salva (mesmo sem filtros) #}
                <div class="text-center py-10">
                     <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2zm0-2c2.761 0 5 1.791 5 4s-2.239 4-5 4-5-1.791-5-4 2.239-4 5-4zm0 10c-2.761 0-5 1.791-5 4v1a1 1 0 001 1h8a1 1 0 001-1v-1c0-2.209-2.239-4-5-4z" />
                     </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Ninguna otra entrada registrada</h3> {# Traduzido #}
                    <p class="mt-1 text-sm text-gray-500">Usa el bot√≥n "A√±adir Entrada" para comenzar.</p> {# Traduzido #}
                </div>
            {% endif %}
        </div>
    </div>

    {# --- Modais (Permanecem os mesmos) --- #}
    <div id="add-outra-receita-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0 modal-overlay">
        <div id="add-outra-receita-modal-content" class="bg-white p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 ease-out scale-95 opacity-0 modal-content">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700">‚ûï A√±adir Nueva Entrada</h2> {# Traduzido #}
                <button id="close-add-outra-receita-modal-btn" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="form-add-outra-receita-modal" action="{{ url_for('add_outra_receita') }}" method="POST" class="space-y-4">
                <div>
                    <label for="descricao_outra_receita_modal" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n:</label> {# Traduzido #}
                    <input type="text" id="descricao_outra_receita_modal" name="descricao_outra_receita" required placeholder="Ej: Venta en l√≠nea, Freelance Proyecto Y" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f]"> {# Traduzido placeholder #}
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="valor_outra_receita_modal" class="block text-sm font-medium text-gray-700 mb-1">Valor ($):</label> {# Traduzido #}
                        <input type="number" step="0.01" id="valor_outra_receita_modal" name="valor_outra_receita" required placeholder="Ej: 150.75" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f]"> {# Mantido placeholder (formato j√° ok) #}
                    </div>
                    <div>
                        <label for="categoria_outra_receita_modal" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a:</label> {# Traduzido #}
                        <select id="categoria_outra_receita_modal" name="categoria_outra_receita" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-[42px]">
                        <option value="" disabled selected>Selecciona...</option> {# Traduzido #}
                        {# Loop usando a vari√°vel passada pelo app.py para esta p√°gina #}
                        {% for cat_form in categorias_receitas_formulario %}
                        <option value="{{ cat_form }}">{{ cat_form }}</option>
                        {% endfor %}
                    </select>
                    </div>
                    <div>
                        <label for="data_outra_receita_modal" class="block text-sm font-medium text-gray-700 mb-1">Fecha de la Entrada:</label> {# Traduzido #}
                        <input type="date" id="data_outra_receita_modal" name="data_outra_receita" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f]">
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button type="button" id="cancel-add-outra-receita-modal-btn" class="mr-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button> {# Traduzido #}
                    <button type="submit" class="bg-[#55d83f] hover:bg-[#47b333] text-black font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-[#55d83f] focus:ring-opacity-75">
                        Guardar Entrada {# Traduzido #}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="filter-receitas-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0 modal-overlay">
        <div id="filter-receitas-modal-content" class="bg-white p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 ease-out scale-95 opacity-0 modal-content">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700">üîç Filtrar y Ordenar Entradas</h2> {# Traduzido #}
                <button id="close-filter-receitas-modal-btn" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form method="GET" action="{{ url_for('receitas') }}" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="data_inicio_modal" class="block text-sm font-medium text-gray-700">Fecha Inicio:</label> {# Traduzido #}
                        <input type="date" name="data_inicio" id="data_inicio_modal" value="{{ filtros_aplicados.data_inicio or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#55d83f] focus:ring-[#55d83f] sm:text-sm py-2 px-3">
                    </div>
                    <div>
                        <label for="data_fim_modal" class="block text-sm font-medium text-gray-700">Fecha Fin:</label> {# Traduzido #}
                        <input type="date" name="data_fim" id="data_fim_modal" value="{{ filtros_aplicados.data_fim or '' }}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#55d83f] focus:ring-[#55d83f] sm:text-sm py-2 px-3">
                    </div>
                    <div>
                        <label for="categoria_filtro_modal" class="block text-sm font-medium text-gray-700">Categor√≠a:</label> {# Traduzido #}
                        <select name="categoria_filtro" id="categoria_filtro_modal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#55d83f] focus:ring-[#55d83f] sm:text-sm h-[42px] bg-white py-2 px-3">
                            <option value="todas" {% if not filtros_aplicados.categoria_filtro or filtros_aplicados.categoria_filtro == 'todas' %}selected{% endif %}>Todas las Categor√≠as</option> {# Traduzido #}
                            {% for cat in categorias_disponiveis %}
                            <option value="{{ cat }}" {% if filtros_aplicados.categoria_filtro == cat %}selected{% endif %}>{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="sort_by_modal" class="block text-sm font-medium text-gray-700">Ordenar Por:</label> {# Traduzido #}
                        <select name="sort_by" id="sort_by_modal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#55d83f] focus:ring-[#55d83f] sm:text-sm h-[42px] bg-white py-2 px-3">
                            <option value="fecha_desc" {% if not filtros_aplicados.sort_by or filtros_aplicados.sort_by == 'fecha_desc' %}selected{% endif %}>Fecha (M√°s Reciente)</option> {# Traduzido #}
                            <option value="fecha_asc" {% if filtros_aplicados.sort_by == 'fecha_asc' %}selected{% endif %}>Fecha (M√°s Antigua)</option> {# Traduzido #}
                            <option value="valor_desc" {% if filtros_aplicados.sort_by == 'valor_desc' %}selected{% endif %}>Valor (Mayor)</option> {# Traduzido #}
                            <option value="valor_asc" {% if filtros_aplicados.sort_by == 'valor_asc' %}selected{% endif %}>Valor (Menor)</option> {# Traduzido #}
                            <option value="categoria_asc" {% if filtros_aplicados.sort_by == 'categoria_asc' %}selected{% endif %}>Categor√≠a (A-Z)</option> {# Traduzido #}
                            <option value="id_desc" {% if filtros_aplicados.sort_by == 'id_desc' %}selected{% endif %}>ID (M√°s Reciente)</option> {# Traduzido #}
                            <option value="id_asc" {% if filtros_aplicados.sort_by == 'id_asc' %}selected{% endif %}>ID (M√°s Antiguo)</option> {# Traduzido #}
                        </select>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-2">
                    <a href="{{ url_for('receitas') }}" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#55d83f]">
                        üßπ Limpiar Filtros {# Traduzido #}
                    </a>
                    <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-black bg-[#55d83f] hover:bg-[#47b333] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#55d83f]">
                        üöÄ Aplicar Filtros {# Traduzido #}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-outra-receita-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0 modal-overlay">
        <div id="edit-outra-receita-modal-content" class="bg-white p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 ease-out scale-95 opacity-0 modal-content">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700">‚úèÔ∏è Editar Entrada</h2> {# Mantido #}
                <button id="close-edit-outra-receita-modal-btn" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="form-edit-outra-receita" method="POST" class="space-y-4">
                <input type="hidden" id="edit-receita-id-input" name="item_id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ID del Ingreso</label> {# Traduzido #}
                    <p id="edit-receita-id-display" class="px-3 py-2 bg-gray-100 text-gray-600 rounded-md text-sm"></p>
                </div>
                <div>
                    <label for="edit-receita-descricao" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n:</label> {# Traduzido #}
                    <input type="text" id="edit-receita-descricao" name="descricao_outra_receita" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f]">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="edit-receita-valor" class="block text-sm font-medium text-gray-700 mb-1">Valor ($):</label> {# Traduzido #}
                        <input type="number" step="0.01" id="edit-receita-valor" name="valor_outra_receita" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f]">
                    </div>
                    <div>
                         <label for="edit-receita-categoria" class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a:</label> {# Traduzido #}
                        <select id="edit-receita-categoria" name="categoria_outra_receita" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f] bg-white h-[42px]">
                        <option value="" disabled>Selecciona...</option> {# Traduzido #}
                         {# Loop usando a vari√°vel passada pelo app.py para esta p√°gina #}
                        {% for cat_form in categorias_receitas_formulario %}
                        <option value="{{ cat_form }}">{{ cat_form }}</option>
                        {% endfor %}
                    </select>
                    </div>
                    <div>
                        <label for="edit-receita-data" class="block text-sm font-medium text-gray-700 mb-1">Fecha de la Entrada:</label> {# Traduzido #}
                        <input type="date" id="edit-receita-data" name="data_outra_receita" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-[#55d83f] focus:border-[#55d83f]">
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button type="button" id="cancel-edit-outra-receita-modal-btn" class="mr-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button> {# Traduzido #}
                    <button type="submit" class="bg-[#55d83f] hover:bg-[#47b333] text-black font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-[#55d83f] focus:ring-opacity-75">
                        Guardar Cambios {# Traduzido #}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-receita-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden p-4 transition-opacity duration-300 opacity-0 modal-overlay">
        <div id="delete-receita-modal-content" class="bg-white p-5 sm:p-6 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 ease-out scale-95 opacity-0 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">üóëÔ∏è Confirmar Eliminaci√≥n</h2> {# Traduzido #}
                <button id="close-delete-receita-modal-btn" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <p class="text-gray-600 mb-2">¬øEst√°s seguro de que deseas eliminar la siguiente entrada?</p> {# Traduzido #}
            <div class="bg-gray-50 p-3 rounded-md border border-gray-200 mb-4 text-sm">
                <p><strong>ID:</strong> <span id="delete-receita-id-display" class="text-gray-700"></span></p>
                <p><strong>Descripci√≥n:</strong> <span id="delete-receita-descricao-display" class="text-gray-700 break-all"></span></p> {# Traduzido #}
                <p><strong>Valor:</strong> <span id="delete-receita-valor-display" class="font-semibold text-green-600"></span></p> {# Mantido #}
            </div>
            <form id="form-delete-receita" method="POST">
                 <input type="hidden" id="delete-receita-id-input" name="item_id">
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancel-delete-receita-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button> {# Traduzido #}
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75">
                        Eliminar {# Traduzido #}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="mobile-actions-receita-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-end justify-center z-50 hidden p-0 transition-opacity duration-300 opacity-0 md:hidden modal-overlay">
        <div id="mobile-actions-receita-modal-content" class="bg-white rounded-t-xl shadow-2xl w-full max-w-md transform transition-all duration-300 ease-out translate-y-full modal-content">
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 text-center">üì± Acciones para Entrada</h3> {# Traduzido #}
                <p class="text-sm text-gray-500 text-center" id="mobile-actions-receita-description"></p>
            </div>
            <div class="py-2">
                <button class="action-button open-edit-receita-btn-mobile">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    Editar {# Mantido #}
                </button>
                <button class="action-button delete open-delete-receita-btn-mobile">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    Eliminar {# Traduzido #}
                </button>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-xl">
                <button id="cancel-mobile-actions-receita-modal-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2.5 px-4 rounded-lg shadow-sm">Cancelar</button> {# Traduzido #}
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// REMOVE o bloco de script antigo que continha displayPageReceitas e updatePaginationControlsReceitas
// O script abaixo √© apenas para os modais (Add, Edit, Delete, Filter, Mobile Actions)

document.addEventListener('DOMContentLoaded', function() {
    // A constante ITEMS_PER_PAGE e a vari√°vel currentPageReceitas N√ÉO s√£o mais necess√°rias aqui
    let currentReceitaRowClicked = null;

    // URLs din√¢micas para actions
    const editReceitaActionUrlTemplate = `/receitas/{item_id}/edit`;
    const deleteReceitaActionUrlTemplate = `/receitas/{item_id}/delete`;

    // --- Fun√ß√£o Gen√©rica para Controle de Modais (Reutilizada) ---
    function setupModal(modalId, openTriggers, closeBtnId, contentId, cancelBtnId, onOpenCallback, slideFromBottom = false) {
        const modal = document.getElementById(modalId);
        const content = document.getElementById(contentId);
        const closeBtn = document.getElementById(closeBtnId);
        const cancelBtn = cancelBtnId ? document.getElementById(cancelBtnId) : null;

        function openModal(relatedTargetOrRow) {
             if (modal && content) {
                // Fecha outros modais abertos
                 document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(otherModal => {
                    if (otherModal.id !== modalId) { // N√£o fechar a si mesmo
                        const otherContent = otherModal.querySelector('.modal-content');
                        const otherCloseBtn = otherModal.querySelector('[id^="close-"], [id^="cancel-"]');
                        if (otherCloseBtn) otherCloseBtn.click();
                        else { // Fallback se n√£o houver bot√£o de fechar padr√£o
                            if(otherContent) otherContent.classList.add('opacity-0', 'scale-95');
                            otherModal.classList.add('opacity-0');
                            setTimeout(() => otherModal.classList.add('hidden'), 300);
                        }
                    }
                });
                // Abre o modal atual
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('opacity-0', 'scale-95', 'translate-y-full'); // Reseta classes
                    if (slideFromBottom) {
                        content.classList.add('translate-y-full');
                        setTimeout(() => content.classList.remove('translate-y-full'), 10);
                    } else {
                        content.classList.add('opacity-100', 'scale-100');
                    }
                }, 10);

                if (onOpenCallback && typeof onOpenCallback === 'function') {
                    onOpenCallback(relatedTargetOrRow);
                }
            }
        }

        function closeModal() {
             if (modal && content) {
                const slide = modal.id === 'mobile-actions-receita-modal'; // Verifica se √© o modal mobile
                if (slide) {
                    content.classList.add('translate-y-full'); // Anima para baixo
                } else {
                    content.classList.remove('opacity-100', 'scale-100');
                    content.classList.add('opacity-0', 'scale-95'); // Anima√ß√£o scale/fade
                }
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Reseta forms de add/edit ao fechar
                    if (modalId === 'add-outra-receita-modal') {
                        const form = document.getElementById('form-add-outra-receita-modal');
                        if (form) form.reset();
                    } else if (modalId === 'edit-outra-receita-modal') {
                        const form = document.getElementById('form-edit-outra-receita');
                        if (form) form.reset();
                    }
                }, 300);
            }
        }

         // Listener para bot√µes din√¢micos (na tabela)
        document.body.addEventListener('click', function(event) {
            if (typeof openTriggers === 'string' && openTriggers.startsWith('.')) {
                const targetButton = event.target.closest(openTriggers);
                if (targetButton) {
                     openModal(targetButton); // Passa o bot√£o que foi clicado
                }
            }
        });

        // Bot√µes est√°ticos (Adicionar, Filtrar)
        if (typeof openTriggers === 'string' && !openTriggers.startsWith('.')) {
            const staticOpenBtn = document.getElementById(openTriggers);
            if (staticOpenBtn) {
                staticOpenBtn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     // Define data padr√£o ao abrir modal de adicionar
                     if (modalId === 'add-outra-receita-modal') {
                         setDefaultDate('data_outra_receita_modal');
                     }
                     openModal(staticOpenBtn); // Passa o bot√£o est√°tico
                });
            }
        }

        if (closeBtn) closeBtn.addEventListener('click', closeModal);
        if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) closeModal();
            });
        }
        return { openModal, closeModal };
    }

    // Fun√ß√£o para definir data padr√£o
    function setDefaultDate(inputId) {
        const dateInput = document.getElementById(inputId);
        if (dateInput && !dateInput.value) {
            const today = new Date();
            const year = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${mm}-${dd}`;
        }
    }

    // --- Inicializar Modais de Receitas ---
    setupModal(
        'add-outra-receita-modal', 'open-add-outra-receita-modal-btn', 'close-add-outra-receita-modal-btn',
        'add-outra-receita-modal-content', 'cancel-add-outra-receita-modal-btn'
    );
    setupModal(
        'filter-receitas-modal', 'open-filter-receitas-modal-btn', 'close-filter-receitas-modal-btn',
        'filter-receitas-modal-content', null // Filtro n√£o tem bot√£o cancelar padr√£o
    );
     const { openModal: openEditReceitaModal } = setupModal(
        'edit-outra-receita-modal', '.open-edit-receita-btn', 'close-edit-outra-receita-modal-btn',
        'edit-outra-receita-modal-content', 'cancel-edit-outra-receita-modal-btn', populateEditReceitaModal
    );
    const { openModal: openDeleteReceitaModal } = setupModal(
        'delete-receita-modal', '.open-delete-receita-btn', 'close-delete-receita-modal-btn',
        'delete-receita-modal-content', 'cancel-delete-receita-modal-btn', populateDeleteReceitaModal
    );
    const { openModal: openMobileActionsReceitaModal, closeModal: closeMobileActionsReceitaModal } = setupModal(
        'mobile-actions-receita-modal', null, null, // Aberto por clique na linha
        'mobile-actions-receita-modal-content', 'cancel-mobile-actions-receita-modal-btn',
        populateMobileActionsReceitaModal, true // Slide from bottom
    );

    // --- Fun√ß√µes para Popular Modais de A√ß√£o (Receitas) ---
    function getReceitaRowData(element) {
        const row = element.closest('tr.table-row-receita');
        if (!row) return null;
        return row.dataset;
    }

    const editReceitaForm = document.getElementById('form-edit-outra-receita');
    function populateEditReceitaModal(triggerElementOrRow) {
        const data = getReceitaRowData(triggerElementOrRow);
        if (!data || !editReceitaForm) return;

        editReceitaForm.reset(); // Limpa o formul√°rio
        const itemId = data.itemId;
        editReceitaForm.action = editReceitaActionUrlTemplate.replace('{item_id}', itemId); // Define action URL

        // Preenche os campos do formul√°rio de edi√ß√£o
        document.getElementById('edit-receita-id-display').textContent = itemId;
        document.getElementById('edit-receita-id-input').value = itemId; // Input hidden
        document.getElementById('edit-receita-descricao').value = data.itemDescricao;
        document.getElementById('edit-receita-valor').value = parseFloat(data.itemValor).toFixed(2); // Garante formato num√©rico
        document.getElementById('edit-receita-categoria').value = data.itemCategoria;
        document.getElementById('edit-receita-data').value = data.itemData; // Data j√° est√° no formato<y_bin_925>-MM-DD
    }

    const deleteReceitaForm = document.getElementById('form-delete-receita');
    function populateDeleteReceitaModal(triggerElementOrRow) {
        const data = getReceitaRowData(triggerElementOrRow);
        if (!data || !deleteReceitaForm) return;

        const itemId = data.itemId;
        deleteReceitaForm.action = deleteReceitaActionUrlTemplate.replace('{item_id}', itemId); // Define action URL

        // Preenche os campos do modal de confirma√ß√£o
        document.getElementById('delete-receita-id-display').textContent = itemId;
        document.getElementById('delete-receita-id-input').value = itemId; // Input hidden
        document.getElementById('delete-receita-descricao-display').textContent = data.itemDescricao;
        // Formata o valor como moeda
        document.getElementById('delete-receita-valor-display').textContent = parseFloat(data.itemValor).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }); // Adaptado para MXN
    }

     function populateMobileActionsReceitaModal(row) {
        currentReceitaRowClicked = row; // Armazena a linha clicada
        const data = getReceitaRowData(row);
        if (!data) return;
        const descriptionEl = document.getElementById('mobile-actions-receita-description');
        if(descriptionEl) {
            descriptionEl.textContent = `ID: ${data.itemId} - ${data.itemDescricao.substring(0,30)}${data.itemDescricao.length > 30 ? '...' : ''}`;
        }
         // Adicionar l√≥gica para desabilitar bot√µes se necess√°rio
    }

    // --- Listeners para Bot√µes DENTRO do Modal Mobile ---
    document.querySelectorAll('.open-edit-receita-btn-mobile').forEach(btn => {
        btn.addEventListener('click', () => {
            if (currentReceitaRowClicked) openEditReceitaModal(currentReceitaRowClicked);
            closeMobileActionsReceitaModal();
        });
    });
    document.querySelectorAll('.open-delete-receita-btn-mobile').forEach(btn => {
        btn.addEventListener('click', () => {
            if (currentReceitaRowClicked) openDeleteReceitaModal(currentReceitaRowClicked);
            closeMobileActionsReceitaModal();
        });
    });

    // --- Listener para Clique na Linha da Tabela (Mobile) ---
    const receitasTableBody = document.getElementById('receitas-table-body');
    if (receitasTableBody) {
        receitasTableBody.addEventListener('click', function(event) {
            // Abre modal apenas em telas menores que lg (1024px)
            if (window.innerWidth < 1024) {
                 const row = event.target.closest('tr.table-row-receita');
                 if (row && !event.target.closest('button, a')) { // N√£o abre se clicar num bot√£o
                     populateMobileActionsReceitaModal(row);
                     openMobileActionsReceitaModal(row);
                 }
            }
        });
    }

    console.log("Receitas page JS updated for server-side pagination.");
});
</script>
{% endblock %}